## Ansible Basics

http://www.devsbytes.com/simple-orchestration-ansible.html

### Basic Modules

- debug print commands output

```yaml
# http://serverfault.com/questions/537060/how-to-see-stdout-of-ansible-commands
- name: print to stdout
  command: echo "hello"
  register: hello

- debug: msg="{{ hello.stdout }}"

- debug: msg="{{ hello.stderr }}"
```

- when

```yaml
---
- hosts: localhost
  connection: local
  vars:
    destroy: true
  tasks:
    - debug:
      when: destroy
```

```yaml
---
- hosts: localhost
  connection: local
  vars:
    destroy: false
  tasks:
    - debug:
      when: not destroy
```

- when regex pattern match

```yaml
---
- hosts: localhost
  connection: local
  vars:
    msg: "Error unpacking rpm package python2-crypto-2.6.1-9.el7.x86_64\n"
  tasks:
    - debug:
      when: msg | match("Error unpack.*crypto-2.6.1-9.*")
```

- [Write variable to a file in Ansible](http://stackoverflow.com/questions/26638180/write-variable-to-a-file-in-ansible)

```yaml
---
- hosts: localhost
  connection: local
  vars:
    your_json_feed: "'key': 'value'"
  tasks:
    - name: Write variable to a file
      copy: content="{{ your_json_feed }}" dest=/path/to/destination/file

    - name: Write variable to a file
      copy:
        content="{{ your_json_feed }}"
        dest=/path/to/destination/file

    - name: Write variable to a file
      copy:
        content: "{{ your_json_feed }}"
        dest: /path/to/destination/file
```

- lineinfile

```yaml
---
- hosts: localhost
  connection: local
  vars:
    destroy: false
  tasks:
  - name: rebuild osd after reboot
    lineinfile:
      dest: test.conf
      insertafter: "^task"
      line: "pre-start script\n  set -e"
```

- blockinfile

```yaml
---
- hosts: localhost
  connection: local
  vars:
    destroy: false
  tasks:
  - name: rebuild osd after reboot
    blockinfile:
      dest: /etc/init/ceph-osd-all-starter.conf
      insertafter: "^task"
      block: |
        pre-start script
          set -e
          /opt/setup_storage/losetup.sh
        end script
```

- Playbook jinja2 filters

```yaml
# http://docs.ansible.com/ansible/playbooks_filters.html

---
- hosts: localhost
  connection: local
  vars:
    live_migration_flag:
      - 'VIR_MIGRATE_UNDEFINE_SOURCE'
      - 'VIR_MIGRATE_PEER2PEER'
      - 'VIR_MIGRATE_LIVE'
      - 'VIR_MIGRATE_PERSIST_DEST'
      - 'VIR_MIGRATE_TUNNELLED'

  tasks:
  - name: dump live_migration_flag
    debug:
      msg: "live_migration_flag={{ live_migration_flag | join(',') }}"
```


## Ansible template 

http://docs.ansible.com/ansible/playbooks_filters.html

    {{ some_variable | to_json }}
    {{ some_variable | to_yaml }}
